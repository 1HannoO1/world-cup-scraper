# -*- coding: utf-8 -*-
"""Untitled19.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xaAvZ5NwCIcOVuq4xHS8YP74w5mmr1QI
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from pymongo import MongoClient

st.set_page_config(layout="wide")
st.title("‚öΩ FIFA World Cup Matches Dashboard (1930 - 2022)")

# MongoDB connection
@st.cache_resource
def load_data():
    client = MongoClient("mongodb+srv://MuhannadMustafa:mmmuhannaddd@cluster0.9n4ckv1.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0&tls=true")
    db = client["fifa_world_cup"]
    collection = db["matches"]
    data = list(collection.find())
    df = pd.DataFrame(data)

    # Ensure required columns exist
    expected_cols = ['year', 'date', 'team1', 'score1', 'team2', 'score2', 'stage', 'city']
    for col in expected_cols:
        if col not in df.columns:
            df[col] = None

    # Drop exact duplicates (row-wise duplicates, not logical)
    df.drop_duplicates(inplace=True)

    # Clean and fill missing values
    df.fillna("None", inplace=True)

    # Ensure scores are numeric (in case they came in as strings)
    df['score1'] = pd.to_numeric(df['score1'], errors='coerce').fillna(0).astype(int)
    df['score2'] = pd.to_numeric(df['score2'], errors='coerce').fillna(0).astype(int)

    # Calculate total goals
    df['total_goals'] = df['score1'] + df['score2']

    return df

# MongoDB Refresh Button (put this after df = load_data())
st.sidebar.markdown("---")
st.sidebar.markdown("### üõ† Admin Tools")

if st.sidebar.button("üîÅ Refresh MongoDB Data"):
    with st.spinner("Refreshing data in MongoDB..."):
        # Reconnect
        client = MongoClient("mongodb+srv://MuhannadMustafa:mmmuhannaddd@cluster0.9n4ckv1.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0&tls=true")
        db = client["fifa_world_cup"]
        collection = db["matches"]

        # Drop existing documents
        collection.delete_many({})

        try:
            df_fifa = pd.read_csv("your_cleaned_fifa_data.csv")  # Replace with your actual source
            data_dict = df_fifa.fillna("None").to_dict("records")
            collection.insert_many(data_dict)
            st.success("‚úÖ MongoDB data refreshed successfully!")
        except Exception as e:
            st.error(f"‚ùå Error during refresh: {e}")

df = load_data()
df.fillna("None", inplace=True)
df['total_goals'] = df['score1'] + df['score2']

# Sidebar filters
st.sidebar.header("üîç Filter Matches")
years = sorted(df['year'].unique())
selected_years = st.sidebar.multiselect("Select Years", years, default=[2022])

all_stages = sorted(df['stage'].unique())

# Filter out the group letter stages (Group A, Group B, etc.)
filtered_stages = [stage for stage in all_stages if not (stage.startswith('Group ') and len(stage) == 7 and stage[-1].isalpha())]

selected_stages = st.sidebar.multiselect("Select Stages", filtered_stages, default=["Final", "Semi-finals"])

teams = sorted(set(df['team1'].unique()) | set(df['team2'].unique()))
selected_team = st.sidebar.selectbox("Filter by Team", ["All"] + teams)

cities = sorted(df['city'].unique())
selected_city = st.sidebar.selectbox("Filter by City", ["All"] + cities)

# Filter DataFrame
filtered_df = df[
    df['year'].isin(selected_years) & 
    df['stage'].isin(selected_stages)
]

if selected_team != "All":
    filtered_df = filtered_df[
        (filtered_df['team1'] == selected_team) | 
        (filtered_df['team2'] == selected_team)
    ]

if selected_city != "All":
    filtered_df = filtered_df[filtered_df['city'] == selected_city]

# Display filtered data with all columns except MongoDB _id
st.subheader("üìã Filtered Matches")
st.dataframe(filtered_df, height=300, use_container_width=True)

# Plot 1: Matches per year
st.subheader("üìä Number of Matches per World Cup Edition")
match_counts = df['year'].value_counts().sort_index()
fig1 = px.bar(x=match_counts.index, y=match_counts.values,
              labels={'x': 'Year', 'y': 'Number of Matches'},
              title="Matches per Year",
              color=match_counts.values, color_continuous_scale='Blues')
st.plotly_chart(fig1, use_container_width=True)

# Plot 2: Goals by stage (Boxplot)
st.subheader("‚öΩ Goal Distribution by Stage")
order = ['Group stage', 'Round of 16', 'Quarter-finals', 'Semi-finals', 'Third place play-off', 'Final']
goals_df = df[df['stage'].isin(order)]
fig2 = px.box(goals_df, x='stage', y='total_goals', category_orders={'stage': order},
              title="Goals by Stage", color='stage')
fig2.update_traces(marker_color='orange')
st.plotly_chart(fig2, use_container_width=True)

# Plot 3: Avg goals per year
st.subheader("üìà Average Goals per Match by Edition")
avg_goals = df.groupby('year')['total_goals'].mean().reset_index()
fig3 = px.line(avg_goals, x='year', y='total_goals', markers=True,
               labels={'total_goals': 'Avg Goals'},
               title="Average Goals per Match (by Year)")
fig3.update_traces(line=dict(color='green', width=3))
st.plotly_chart(fig3, use_container_width=True)

# Plot 4: Most common results (Mirrored)
st.subheader("üèÜ Top 10 Most Common Match Results")
df['norm_score1'] = df[['score1', 'score2']].min(axis=1)
df['norm_score2'] = df[['score1', 'score2']].max(axis=1)
result_counts = df.groupby(['norm_score1', 'norm_score2']).size().reset_index(name='count')
result_counts['result'] = result_counts['norm_score1'].astype(str) + '-' + result_counts['norm_score2'].astype(str)
top_results = result_counts.sort_values('count', ascending=False).head(10)

fig4 = px.bar(top_results, x='count', y='result', orientation='h',
              labels={'count': 'Match Count', 'result': 'Scoreline'},
              title="Top 10 Most Common Match Results", color='count', color_continuous_scale='viridis')
fig4.update_layout(yaxis={'categoryorder': 'total ascending'})
st.plotly_chart(fig4, use_container_width=True)

# Plot 5: Top 10 Highest Scoring Teams
st.subheader("ü•Ö Top 10 Highest Scoring Teams (All Time)")

# Combine team1 and team2 scores
goals_team1 = df.groupby('team1')['score1'].sum().reset_index().rename(columns={'team1': 'team', 'score1': 'goals'})
goals_team2 = df.groupby('team2')['score2'].sum().reset_index().rename(columns={'team2': 'team', 'score2': 'goals'})
total_goals_by_team = pd.concat([goals_team1, goals_team2]).groupby('team')['goals'].sum().reset_index()

top_goal_teams = total_goals_by_team.sort_values(by='goals', ascending=False).head(10)

fig5 = px.bar(top_goal_teams, x='team', y='goals', color='goals', title='Top 10 Highest Scoring Teams',
              labels={'goals': 'Total Goals', 'team': 'Team'}, color_continuous_scale='Reds')
st.plotly_chart(fig5, use_container_width=True)

# Plot 6: Top 10 Teams by Number of Matches Played
st.subheader("üìÖ Top 10 Teams by Matches Played")

team1_counts = df['team1'].value_counts().reset_index()
team2_counts = df['team2'].value_counts().reset_index()
team1_counts.columns = ['team', 'matches']
team2_counts.columns = ['team', 'matches']

total_matches = pd.concat([team1_counts, team2_counts]).groupby('team')['matches'].sum().reset_index()
top_teams_by_matches = total_matches.sort_values('matches', ascending=False).head(10)

fig6 = px.bar(top_teams_by_matches, x='team', y='matches', color='matches', title='Top 10 Teams by Matches Played',
              labels={'matches': 'Matches Played', 'team': 'Team'}, color_continuous_scale='Blues')
st.plotly_chart(fig6, use_container_width=True)


# Plot 7: Cities with Most Matches Hosted
st.subheader("üèüÔ∏è Cities with Most Matches Hosted")

city_counts = df['city'].value_counts().reset_index()
city_counts.columns = ['city', 'matches']
top_cities = city_counts.head(10)

fig7 = px.bar(top_cities, x='matches', y='city', orientation='h', color='matches',
              title='Top 10 Cities by Matches Hosted', color_continuous_scale='plasma')
fig7.update_layout(yaxis={'categoryorder': 'total ascending'})
st.plotly_chart(fig7, use_container_width=True)


# Plot 8: Distribution of Winning Margins
st.subheader("üìè Winning Margin Distribution")

df['winning_margin'] = abs(df['score1'] - df['score2'])

fig8 = px.histogram(df, x='winning_margin', nbins=10, title="Distribution of Winning Margins",
                    labels={'winning_margin': 'Goal Difference'}, color_discrete_sequence=['teal'])
st.plotly_chart(fig8, use_container_width=True)


# Plot 9: Cumulative Matches Over the Years
st.subheader("üìà Cumulative Number of Matches Over Time")

matches_per_year = df['year'].value_counts().sort_index().reset_index()
matches_per_year.columns = ['year', 'matches']
matches_per_year['cumulative_matches'] = matches_per_year['matches'].cumsum()

fig9 = px.line(matches_per_year, x='year', y='cumulative_matches', markers=True,
               title="Cumulative Number of Matches Over Time", labels={'cumulative_matches': 'Cumulative Matches'})
st.plotly_chart(fig9, use_container_width=True)


# Download full CSV
st.sidebar.markdown("### üì• Download")
csv = df.to_csv(index=False).encode('utf-8')
st.sidebar.download_button("Download Full Dataset", data=csv, file_name="Fifa_World_Cup_Matches_1930_2022.csv", mime='text/csv')